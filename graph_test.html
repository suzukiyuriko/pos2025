
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Graph Excel 連携テスト</title>
  https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js</script>
</head>
<body style="font-family: system-ui, -apple-system, Segoe UI, sans-serif; padding: 24px;">
  <h1>Graph Excel 連携テスト</h1>
  <p>右下のボタンから、OneDrive の「売上統合.xlsx」に1行追加します。</p>

  <script>
  const CLIENT_ID    = "07b8d7ed-60cd-4ae9-b6f2-19951af38ebc";
  const TENANT_ID    = "527dad28-286b-4aed-a521-3464a410694d";
  const REDIRECT_URI = "https://suzukiyuriko.github.io/pos2025/graph_test.html";
  const tableName    = "Table1"; // ←通ったらExcel側をTransactionsに改名し、ここも合わせる
  const FILE_PATH_CANDIDATES = ["/売上統合.xlsx","/Documents/売上統合.xlsx","/ドキュメント/売上統合.xlsx"];

  const graphBase = "https://graph.microsoft.com/v1.0";
  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI,
      postLogoutRedirectUri: REDIRECT_URI
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true }
  };
  const loginRequest = { scopes: ["Files.ReadWrite", "openid", "profile", "offline_access"] };
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  function overlay(text){
    const d=document.createElement("div");
    d.style.cssText="position:fixed;left:16px;bottom:16px;z-index:999999;background:#300;color:#fff;padding:10px;border-radius:8px;max-width:90vw;font:12px/1.4 monospace;white-space:pre-wrap;";
    d.textContent=text; document.body.appendChild(d);
  }
  window.addEventListener("error",e=>overlay("JS Error: "+e.message));
  window.addEventListener("unhandledrejection",e=>overlay("Promise: "+(e.reason?.message||e.reason)));

  async function signIn(){
    const accts=msalInstance.getAllAccounts();
    if(accts.length>0) return accts[0];
    await msalInstance.loginRedirect(loginRequest);
  }
  async function getToken(){
    const account=msalInstance.getAllAccounts()[0];
    try{
      const res=await msalInstance.acquireTokenSilent({...loginRequest,account});
      return res.accessToken;
    }catch{
      await msalInstance.acquireTokenRedirect(loginRequest);
    }
  }
  async function pickFileBase(token){
    for(const p of FILE_PATH_CANDIDATES){
      const r=await fetch(`${graphBase}/me/drive/root:${p}`,{headers:{Authorization:`Bearer ${token}`}}); 
      if(r.ok) return `${graphBase}/me/drive/root:${p}:`;
    }
    throw new Error("売上統合.xlsx が見つかりません。まずは OneDrive の“ルート直下”に置いてください。");
  }
  async function appendRowSimple(values){
    const token=await getToken();
    const base=await pickFileBase(token);
    const res=await fetch(`${base}/workbook/tables/${encodeURIComponent(tableName)}/rows/add`,{
      method:"POST",
      headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
      body:JSON.stringify({values:[values]})
    });
    if(!res.ok){
      const t=await res.text();
      throw new Error(`行追加に失敗: ${res.status}\n${t}`);
    }
  }

  document.addEventListener("DOMContentLoaded",async()=>{
    const b=document.createElement("div");
    b.textContent="DEBUG: JS running";
    b.style.cssText="position:fixed;left:16px;top:16px;background:#0a0;color:#fff;padding:6px 8px;border-radius:6px;font:12px monospace;z-index:99999";
    document.body.appendChild(b);

    const btn=document.createElement("button");
    btn.textContent="（テスト）Excelに1行追加";
    btn.style.cssText="position:fixed;right:16px;bottom:16px;z-index:99999;padding:10px 14px;border-radius:999px;border:none;background:#0067c0;color:#fff;font-weight:bold;";
    btn.onclick=async()=>{
      try{
        await signIn();
        const now=new Date().toISOString();
        const row=[now,"TEST","テスト商品",100,1,100,100,"現金",0];
        await appendRowSimple(row);
        alert("✅ 追加しました。Excelの末尾を確認してください。");
      }catch(e){
        alert("❌ 追加できませんでした。\n\n"+(e.message||e));
        console.error(e);
      }
    };
    document.body.appendChild(btn);
  });
  </script>
</body>
</html>
