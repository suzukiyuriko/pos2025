<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>かんたん会計</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #222;
      --muted: #666;
      --accent: #3b82f6;
      --danger: #ef4444;
      --ok: #16a34a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 1.2fr 1fr; }
    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 22px; margin: 0; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); padding: 16px; }
    .group { display: flex; gap: 12px; margin-bottom: 12px; }
    .btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px;
           padding: 20px; font-weight: 700; font-size: 20px; cursor: pointer; background: #eef2ff; user-select: none;
           height: 100px; }
    .btn .price { font-size: 16px; font-weight: 600; color: var(--muted); }
    .btn.smallFont { font-size: 18px; }
    .right { display: grid; gap: 16px; grid-template-rows: auto 1fr auto; }
    .list { max-height: 300px; overflow: auto; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; text-align: left; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #f0f3ff; }
    tbody tr:nth-child(odd) { background: #fafbff; }
    .total { font-size: 24px; font-weight: 900; }
    input[type="number"], input[type="text"] { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .actionBtn { padding: 10px 14px; border-radius: 8px; border: 0; cursor: pointer; font-weight: 700; }
    .primary { background: var(--accent); color: #fff; }
    .danger { background: #e0f2ff; color: #000; }
    .ok { background: var(--ok); color: #fff; font-size: 18px; padding: 16px 24px; }
    .muted { background: #e5e7eb; }
    .small { font-size: 12px; color: var(--muted); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .group { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>2025年度生徒食品販売</h1>
      <div class="actions">
        <button class="actionBtn ok" id="downloadCsv">CSVダウンロード</button>
      </div>
    </header>

    <!-- 左側 商品ボタン -->
    <section class="card" id="items"></section>

    <!-- 右側 会計エリア -->
    <section class="right">
      <div class="card list">
        <table>
          <thead>
            <tr>
              <th>品名</th><th>単価</th><th>数量</th><th>小計</th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="total">合計：<span id="grandTotal">¥0</span></div>
        <div class="grid2" style="margin-top:10px">
          <div><label class="small">いただいた金額</label><input type="number" id="paidInput" inputmode="numeric" placeholder="0"></div>
          <div><label class="small">お釣り</label><input type="text" id="changeOut" readonly></div>
        </div>
      </div>
      <div class="card">
        <button class="actionBtn ok" id="checkoutBtn">会計 確定</button>
      </div>
    </section>
  </div>

  <script>
    const itemsData = {
      BR: {id:'BR', name:'ベリールージュ', price:160, small:true},
      LB: {id:'LB', name:'ラグーンブルー', price:160, small:true},
      RB: {id:'RB', name:'レインボー', price:270},
      CC: {id:'CC', name:'クッキー＆クリーム', price:270},
      HC: {id:'HC', name:'ハニーコットン', price:270, small:true},
      CH: {id:'CH', name:'チュロス', price:220},
      KA: {id:'KA', name:'唐揚げ', price:120}
    };
    const itemGroups = [
      ['BR','LB'],
      ['RB','CC','HC'],
      ['CH','KA']
    ];

    let cart = [];
    function yen(n){ return '¥' + n.toLocaleString('ja-JP'); }
    function renderItems(){
      const wrap=document.getElementById('items');
      wrap.innerHTML='';
      itemGroups.forEach(groupIds=>{
        const group=document.createElement('div');
        group.className='group';
        groupIds.forEach(id=>{
          const it=itemsData[id];
          const btn=document.createElement('button');
          btn.className='btn'+(it.small?' smallFont':'');
          btn.innerHTML=`<div>${it.name}</div><div class="price">${yen(it.price)}</div>`;
          btn.onclick=()=>addToCart(it);
          group.appendChild(btn);
        });
        wrap.appendChild(group);
      });
    }
    function addToCart(it){
      const row=cart.find(r=>r.id===it.id);
      if(row) row.qty++;
      else cart.push({...it, qty:1});
      renderCart();
    }
    function computeTotal(){return cart.reduce((s,r)=>s+r.price*r.qty,0);}

    function renderCart(){
      const body=document.getElementById('cartBody'); 
      body.innerHTML='';
      cart.forEach((r,index)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.name}</td>
          <td>${yen(r.price)}</td>
          <td><input type="number" min="0" value="${r.qty}" data-index="${index}" class="qtyInput" style="width:60px"></td>
          <td>${yen(r.price*r.qty)}</td>
          <td><button class="actionBtn danger small deleteBtn" data-index="${index}">削除</button></td>
        `;
        body.appendChild(tr);
      });

      // 数量変更イベント
      body.querySelectorAll('.qtyInput').forEach(input=>{
        input.addEventListener('input',(e)=>{
          const idx=e.target.dataset.index;
          const val=parseInt(e.target.value||'0',10);
          if(val<=0){ 
            cart.splice(idx,1); // 0以下なら削除
          } else {
            cart[idx].qty=val;
          }
          renderCart();
        });
      });

      // 削除ボタンイベント
      body.querySelectorAll('.deleteBtn').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const idx=e.target.dataset.index;
          cart.splice(idx,1);
          renderCart();
        });
      });

      document.getElementById('grandTotal').textContent=yen(computeTotal());
      updateChange();
    }

    const paidInput=document.getElementById('paidInput');
    const changeOut=document.getElementById('changeOut');
    paidInput.addEventListener('input',updateChange);
    function updateChange(){
      const paid=parseInt(paidInput.value||'0',10);
      const change=paid-computeTotal();
      changeOut.value= change>=0 ? yen(change) : '不足:'+yen(-change);
    }
    document.getElementById('checkoutBtn').addEventListener('click',()=>{
      if(cart.length===0) return alert('カートが空です');
      const paid=parseInt(paidInput.value||'0',10);
      const total=computeTotal();
      if(paid<total) return alert('お支払いが不足しています');
      const journal=JSON.parse(localStorage.getItem('journal')||'[]');
      journal.push({
        ts:new Date().toISOString(),
        lines:cart.map(r=>({id:r.id,name:r.name,price:r.price,qty:r.qty,subtotal:r.price*r.qty})),
        total,paid,change:paid-total
      });
      localStorage.setItem('journal',JSON.stringify(journal));
      cart=[]; renderCart(); paidInput.value=''; updateChange();
      alert('会計を記録しました');
    });
    document.getElementById('downloadCsv').addEventListener('click',()=>{
      const journal=JSON.parse(localStorage.getItem('journal')||'[]');
      if(journal.length===0) return alert('データがありません');
      let csv='Timestamp,ItemId,ItemName,Price,Qty,Subtotal,Total,Paid,Change\n';
      journal.forEach(j=>{
        j.lines.forEach(r=>{
          csv+=`${j.ts},${r.id},${r.name},${r.price},${r.qty},${r.subtotal},${j.total},${j.paid},${j.change}\n`;
        });
      });
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='sales.csv'; a.click();
      URL.revokeObjectURL(url);
      if(confirm('記録を消去しますか？')) localStorage.removeItem('journal');
    });
    renderItems(); renderCart();
  </script>
<!-- MSAL v2 (Auth Code + PKCE) -->
https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js</script>
<script>
/** ====== ここをあなたの環境に合わせて設定 ====== **/
// 1) Microsoft Entra のアプリ登録から
const CLIENT_ID = "07b8d7ed-60cd-4ae9-b6f2-19951af38ebc";
const TENANT_ID = "527dad28-286b-4aed-a521-3464a410694d";

// 2) GitHub Pagesで公開している“このページ”のURL（SPAのリダイレクト先）
//   例: https://suzukiyuriko.github.io/pos2025/kaikei_edit_v3.html
//   ※このURLを、Entraの「認証 > シングルページアプリ」のリダイレクトURIにも必ず登録してください
const REDIRECT_URI = "https://suzukiyuriko.github.io/pos2025/kaikei_edit_v3.html";

// 3) OneDrive上のExcelファイルとテーブル名
//   ルート直下なら "/売上統合.xlsx"。フォルダ配下にあるなら "/POS/売上統合.xlsx" のように変更
const filePath  = "/売上統合.xlsx";
const tableName = "Transactions"; // Excelで付けたテーブル名

/** ====== ここから下は基本そのままでOK ====== **/
const msalConfig = {
  auth: {
    clientId: CLIENT_ID,
    authority: `https://login.microsoftonline.com/${TENANT_ID}`,
    redirectUri: REDIRECT_URI,
    postLogoutRedirectUri: REDIRECT_URI
  },
  cache: {
    cacheLocation: "localStorage",
    storeAuthStateInCookie: true // iPad/Safari 安定化
  }
};
const loginRequest = {
  scopes: ["Files.ReadWrite", "openid", "profile", "offline_access"]
};

const graphBase = "https://graph.microsoft.com/v1.0";
// OneDrive（自分の）のルートからのパスで指定
const fileBase  = `${graphBase}/me/drive/root:${filePath}:`;

const msalInstance = new msal.PublicClientApplication(msalConfig);

// ---- 認証（Safariはポップアップよりredirectが安定）----
async function signIn() {
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) return accounts[0];
  await msalInstance.loginRedirect(loginRequest);
}
async function getToken() {
  const account = msalInstance.getAllAccounts()[0];
  try {
    const res = await msalInstance.acquireTokenSilent({ ...loginRequest, account });
    return res.accessToken;
  } catch {
    await msalInstance.acquireTokenRedirect(loginRequest);
  }
}

// ---- Excel永続セッション（パフォーマンス＆安定性UP）----
let workbookSessionId = null;
async function ensureWorkbookSession(accessToken) {
  if (workbookSessionId) return workbookSessionId;
  const res = await fetch(`${fileBase}/workbook/createSession`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ persistChanges: true })
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`createSession failed: ${res.status} ${txt}`);
  }
  const data = await res.json();
  workbookSessionId = data.id;
  return workbookSessionId;
}

// ---- 1会計 = 1行 追加（列順配列でテーブルに追加）----
async function appendRow(values /* [時間, コード, 商品名, 価格, 数量, 小計, 合計, 支払い, お釣り] */) {
  const token = await getToken();
  const sessionId = await ensureWorkbookSession(token);

  let res = await fetch(`${fileBase}/workbook/tables/${encodeURIComponent(tableName)}/rows/add`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json",
      "workbook-session-id": sessionId
    },
    body: JSON.stringify({ values: [values] })
  });

  // 簡易リトライ（429/5xx）
  if (res.status === 429 || res.status >= 500) {
    await new Promise(r => setTimeout(r, 800));
    res = await fetch(`${fileBase}/workbook/tables/${encodeURIComponent(tableName)}/rows/add`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "workbook-session-id": sessionId
      },
      body: JSON.stringify({ values: [values] })
    });
  }

  if (!res.ok) {
    // セッション切れなどはセッション作り直し→再送で回復を試みる
    if (workbookSessionId) {
      workbookSessionId = null;
      const newSessionId = await ensureWorkbookSession(token);
      const retry = await fetch(`${fileBase}/workbook/tables/${encodeURIComponent(tableName)}/rows/add`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
          "workbook-session-id": newSessionId
        },
        body: JSON.stringify({ values: [values] })
      });
      if (retry.ok) return;
    }
    const txt = await res.text();
    throw new Error(`rows/add failed: ${res.status} ${txt}`);
  }
}

// ---- あなたの会計確定処理から呼ぶ公開関数 ----
async function saveTransaction(row /* 上の列順の配列 */) {
  try {
    await signIn();
    await appendRow(row);
    // 必要なら：音・バイブ・画面リセットなどのUI
  } catch (e) {
    console.error(e);
    alert("送信に失敗しました。ネットワークやサインイン状態、Excelファイルの共有設定を確認してください。");
  }
}

// ---- 動作確認用：仮のテスト送信ボタンをページに追加（任意）----
window.addEventListener("DOMContentLoaded", () => {
  // 先にサインインだけ済ませておく（任意）
  signIn();

  // デバッグ用の仮ボタン（不要なら削除OK）
  const btn = document.createElement("button");
  btn.textContent = "（テスト）1行追加";
  btn.style.cssText = "position:fixed;right:16px;bottom:16px;z-index:9999;";
  btn.onclick = () => {
    const now = new Date().toISOString();
    const testRow = [
      now,               // 時間ジカン
      "CODE-TEST",       // コード
      "テスト商品",       // 商品名ショウヒンメイ
      100,               // 価格カカク
      2,                 // 数量スウリョウ
      200,               // 小計ショウケイ
      200,               // 合計ゴウケイ
      "現金",            // 支払いシハラ
      0                  // お釣りツ
    ];
    saveTransaction(testRow);
  };
  document.body.appendChild(btn);
});
</script>
<script>
(function () {
  // 画面右下にログパネルを作成
  function ensurePanel() {
    let p = document.getElementById("diag-panel");
    if (p) return p;
    p = document.createElement("div");
    p.id = "diag-panel";
    p.style.cssText = "position:fixed;right:16px;bottom:72px;width:320px;max-height:50vh;overflow:auto;background:#111;color:#0f0;font:12px/1.4 monospace;padding:8px;border-radius:8px;z-index:99999;opacity:0.95;";
    document.body.appendChild(p);
    return p;
  }
  function log(msg) {
    const p = ensurePanel();
    const line = document.createElement("div");
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    p.appendChild(line);
    p.scrollTop = p.scrollHeight;
  }
  async function runDiag() {
    try {
      log("診断開始");
      await signIn();
      const acct = msalInstance.getAllAccounts()[0];
      log(`サインイン: ${acct?.username || "(不明)"}`);
      const token = await getToken();
      log("アクセストークン取得OK");

      // 1) ファイルに到達できるか
      let res = await fetch(`${fileBase}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      log(`GET file (${filePath}): ${res.status}`);
      if (!res.ok) {
        log(await res.text());
        log("❌ ファイルパス/アカウント権限を確認してください");
        return;
      }

      // 2) テーブル一覧取得
      res = await fetch(`${fileBase}/workbook/tables`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const tables = await res.json();
      const names = (tables.value || []).map(t => t.name);
      log(`テーブル一覧: ${JSON.stringify(names)}`);
      if (!names.includes(tableName)) {
        log(`❌ テーブル名「${tableName}」が見つかりません（Excel側で名前を確認/変更してください）`);
        return;
      }

      // 3) 永続セッション作成
      const sessionId = await ensureWorkbookSession(token);
      log(`セッションOK: ${sessionId.substring(0, 8)}...`);

      // 4) テスト行を追加
      const now = new Date().toISOString();
      const testRow = [now, "DBG", "診断テスト", 1, 1, 1, 1, "現金", 0];
      res = await fetch(`${fileBase}/workbook/tables/${encodeURIComponent(tableName)}/rows/add`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
          "workbook-session-id": sessionId
        },
        body: JSON.stringify({ values: [testRow] })
      });
      log(`rows/add: ${res.status}`);
      if (!res.ok) {
        log(await res.text());
        log("❌ rows/add 失敗（レスポンス上のエラー文をお知らせください）");
        return;
      }
      log("✅ 追加成功（Excelで末尾に「診断テスト」が入るはずです）");
    } catch (e) {
      log("例外: " + (e?.message || e));
    }
  }

  // フローティング診断ボタン
  window.addEventListener("DOMContentLoaded", () => {
    const btn = document.createElement("button");
    btn.textContent = "診断";
    btn.style.cssText = "position:fixed;right:16px;bottom:16px;z-index:99999;padding:10px 14px;border-radius:999px;border:none;background:#0067c0;color:#fff;font-weight:bold;";
    btn.onclick = runDiag;
    document.body.appendChild(btn);
  });
})();
</script>
</body>
</html>
